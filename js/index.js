// TRANSLATIONS (same as before with updated project text)
const translations = {
    en: {
        brand_name: "Karunya Geriatric Care Centre",
        nav_home: "Home",
        nav_activity: "Activity",
        nav_about: "About",
        nav_projects: "Projects",
        nav_support: "Support Us",

        hero_title: "PALAKKAD ALZHEIMER'S CHARITABLE TRUST\nKarunya Gereitric Care Centre",
        hero_quote: "Service to mankind is service to God.",

        btn_learn_more: "Learn More",
        btn_donate: "Donate Now",

        section_events_title: "Recent Events",
        section_events_desc: "Joyful moments and community gatherings at our home.",

        section_project_subtitle: "Our Initiatives",
        section_project_title: "Karunya Medical Centre",
        project_card_title: "Karunya Medical Centre",
        project_desc: "Karunya Medical Centre, started in July 2024, supports the palliative care needs of our residents and nearby community. We focus on comfort, dignity and a peaceful environment rather than intensive hospital treatment.",
        project_feat_1: "Comfortable, home-like atmosphere for palliative care.",
        project_feat_2: "Emotional and practical support for residents and families.",
        project_feat_3: "Ambulance and doctor visits arranged on a need basis.",

        about_title: "About Karunya",
        about_p1: "Established in 2005, Karunya Old Age Home has been a sanctuary for the destitute and the elderly who have nowhere else to go. We believe that every silver-haired individual deserves a sunset filled with dignity, love, and care.",
        about_p2: "Our home provides food, shelter, medical care, and most importantly, a family-like atmosphere. We are run by a dedicated trust and supported by the kindness of people like you.",
        btn_more_about: "More About Us",

        donate_title: "Your Support Matters",
        donate_desc: "Help us keep the smiles on their faces. Even a small contribution can provide a meal or medicine for an elderly resident.",

        bank_transfer: "Bank Transfer",
        scan_pay: "Scan to pay instantly",
        sponsor_meal: "Sponsor a Meal",
        sponsor_desc: "Celebrate your special days by feeding the residents.",
        btn_contact_sponsor: "Contact to Sponsor",
        btn_more_donation: "View Full Donation Details",

        footer_about: "Providing care, love, and shelter to the elderly since 2005. Registered Charitable Trust No. 123/2005.",
        footer_links: "Quick Links",
        footer_contact: "Contact",
        footer_social: "Follow Us"
    },
    ml: {
        brand_name: "കാരുണ്യ",
        nav_home: "വീട്",
        nav_activity: "പ്രവർത്തനങ്ങൾ",
        nav_about: "ഞങ്ങളെക്കുറിച്ച്",
        nav_projects: "പദ്ധതികൾ",
        nav_support: "സഹായിക്കൂ",

        hero_title: "കാരുണ്യ വൃദ്ധസദനം",
        hero_quote: "മാനവ സേവ മാധവ സേവ.",

        btn_learn_more: "കൂടുതൽ അറിയാൻ",
        btn_donate: "സംഭാവന ചെയ്യുക",

        section_events_title: "സമീപകാല പ്രവർത്തനങ്ങൾ",
        section_events_desc: "ഞങ്ങളുടെ ഭവനത്തിലെ സന്തോഷ നിമിഷങ്ങൾ.",

        section_project_subtitle: "ഞങ്ങളുടെ സംരംഭങ്ങൾ",
        section_project_title: "കാരുണ്യ മെഡിക്കൽ സെന്റർ",
        project_card_title: "കാരുണ്യ മെഡിക്കൽ സെന്റർ",
        project_desc: "2024 ജൂലൈയിൽ ആരംഭിച്ച കാരുണ്യ മെഡിക്കൽ സെന്റർ, ഞങ്ങളുടെ അന്തേവാസികൾക്കും സമീപ പ്രദേശങ്ങളിൽ ഉള്ളവർ‍ക്കും വേണ്ടിയുള്ള പാലിയേറ്റീവ് പരിചരണ സഹായമാണ്. ആശുപത്രി ചികിത്സക്ക് പകരം ആശ്വാസം, മാന്യത, സമാധാനം എന്നിവയാണ് ഞങ്ങൾ മുൻ‌ഗണന നൽകുന്നത്.",
        project_feat_1: "പാലിയേറ്റീവ് പരിചരണത്തിന് അനുയോജ്യമായ സുഖകരമായ അന്തരീക്ഷം.",
        project_feat_2: "അന്തേവാസികൾക്കും കുടുംബാംഗങ്ങൾക്കും മാനസികവും പ്രായോഗികവും സഹായം.",
        project_feat_3: "ആവശ്യത്തിനനുസരിച്ച് ആംബുലൻസ്, ഡോക്ടർ സേവനം ക്രമീകരിക്കുന്നു.",

        about_title: "കാരുണ്യയെക്കുറിച്ച്",
        about_p1: "2005-ൽ സ്ഥാപിതമായ കാരുണ്യ വൃദ്ധസദനം, നിരാലംബരായ വയോജനങ്ങൾക്ക് ഒരു അത്താണിയാണ്. സ്നേഹവും പരിചരണവും നിറഞ്ഞ ഒരു സായാഹ്നം അവർ അർഹിക്കുന്നു.",
        about_p2: "ഭക്ഷണം, പാർപ്പിടം, ചികിത്സ എന്നിവയ്‌ക്കൊപ്പം ഒരു കുടുംബം പോലെയാണ് ഞങ്ങൾ കഴിയുന്നത്. സുമനസ്സുകളുടെ സഹായമാണ് ഞങ്ങളുടെ ശക്തി.",
        btn_more_about: "കൂടുതൽ വിവരങ്ങൾ",

        donate_title: "നിങ്ങളുടെ സഹായം വലുതാണ്",
        donate_desc: "ഒരു നേരത്തെ ഭക്ഷണമോ മരുന്നോ നൽകി നിങ്ങൾക്ക് ഇവരെ സഹായിക്കാം.",

        bank_transfer: "ബാങ്ക് ട്രാൻസ്ഫർ",
        scan_pay: "സ്കാൻ ചെയ്ത് പണമടയ്ക്കാം",
        sponsor_meal: "അന്നദാനം",
        sponsor_desc: "നിങ്ങളുടെ വിശേഷദിവസങ്ങളിൽ അന്തേവാസികൾക്ക് ഭക്ഷണം നൽകാം.",
        btn_contact_sponsor: "ബന്ധപ്പെടുക",
        btn_more_donation: "സംഭാവന വിവരങ്ങൾ",

        footer_about: "2005 മുതൽ വയോജനങ്ങൾക്ക് സ്നേഹവും സംരക്ഷണവും നൽകുന്നു. രജിസ്റ്റർ ചെയ്ത ചാരിറ്റബിൾ ട്രസ്റ്റ്.",
        footer_links: "ലിങ്കുകൾ",
        footer_contact: "വിലാസം",
        footer_social: "ഫോളോ ചെയ്യൂ"
    }
};

let currentLang = 'en';

function applyTranslations(){
    document.querySelectorAll('[data-key]').forEach(el=>{
        const key = el.getAttribute('data-key');
        const text = translations[currentLang] && translations[currentLang][key];
        if(text) el.innerText = text;
    });
}

document.addEventListener('DOMContentLoaded',()=>{
    applyTranslations();

    const langBtn = document.getElementById('langBtn');
    const mobileLang = document.getElementById('mobile-lang');
    const langLabel = document.getElementById('lang-label');
    const hamburger = document.getElementById('hamburger');
    const mobileMenu = document.getElementById('mobile-menu');
    const navbar = document.getElementById('navbar');
    const preloader = document.getElementById('preloader');

    /* PRELOADER: minimum 2s, then fade out */
    function hidePreloader(){
        if (!preloader) return;
        if (preloader.classList.contains('preloader-hide')) return;
        preloader.classList.add('preloader-hide');
        setTimeout(()=>{ preloader.style.display = 'none'; },400);
    }

    // guarantee at least 2s
    setTimeout(hidePreloader, 2000);
    window.addEventListener('load', hidePreloader);

    /* SCROLL REVEAL */
    function reveal(){
        document.querySelectorAll('.reveal').forEach(el=>{
            const top = el.getBoundingClientRect().top;
            if(top < window.innerHeight - 120) el.classList.add('active');
        });
    }
    window.addEventListener('scroll',reveal);
    reveal();

    /* EVENTS JSON */
    let eventsData = [];
    let eventsImagesBase = 'images/Events';
    let eventsImageExt = 'jpg';

    function formatBadgeDate(dateStr) {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        if (isNaN(d)) return dateStr;
        const month = d.toLocaleString('en-US', { month: 'short' }).toUpperCase();
        const day = String(d.getDate()).padStart(2, '0');
        return `${month} ${day}`;
    }

    function renderRecentEvents() {
        const grid = document.getElementById('recent-events-grid');
        if (!grid || !eventsData.length) return;

        grid.innerHTML = '';

        const sorted = eventsData.slice().sort(
            (a, b) => new Date(b.date) - new Date(a.date)
        );
        const latestThree = sorted.slice(0, 3);

        latestThree.forEach(event => {
            const useMalayalam = currentLang === 'ml';
            const title = useMalayalam ? (event.title_ml || event.title) : event.title;
            const summary = useMalayalam ? (event.summary_ml || event.summary) : event.summary;

            const badgeText = formatBadgeDate(event.date);
            const firstCoverImageIndex =
                (event.cover && event.cover.length)
                    ? event.cover[0]
                    : (event.images && event.images[0]) || 1;

            const imgSrc =
                `${eventsImagesBase}/${event.folder}/${firstCoverImageIndex}.${eventsImageExt}`;

            // Make the whole card a link to activity.html#<id>
            const cardLink = document.createElement('a');
            cardLink.className = 'card reveal';
            cardLink.href = `activity.html#${event.id}`;

            cardLink.innerHTML = `
                <div class="media media-positioned">
                    <img src="${imgSrc}" alt="${title}" class="img-shadow">
                    <div class="badge">${badgeText}</div>
                </div>
                <div class="body">
                    <h3>${title}</h3>
                    <p>${summary}</p>
                </div>
            `;

            grid.appendChild(cardLink);
        });

        reveal();
    }

    fetch('data/events.json')
        .then(res => res.json())
        .then(data => {
            if (!data) return;
            eventsData = Array.isArray(data.events) ? data.events : [];
            if (data.imagesBase) eventsImagesBase = data.imagesBase;
            if (data.imageExt) eventsImageExt = data.imageExt;
            renderRecentEvents();
        })
        .catch(err => {
            console.error('Failed to load events.json', err);
        });

    /* LANGUAGE TOGGLE */
    function toggleLanguage(){
        currentLang = currentLang === 'en' ? 'ml' : 'en';

        if (langLabel)
            langLabel.innerText = currentLang === 'en' ? 'ENG' : 'MAL';

        if (mobileLang)
            mobileLang.innerText = currentLang === 'en'
                ? 'Switch to Malayalam'
                : 'Switch to English';

        document.body.classList.toggle(
            'font-malayalam',
            currentLang === 'ml'
        );

        document.querySelectorAll('[data-key]').forEach(el=>{
            el.style.transition = 'opacity .2s';
            el.style.opacity = '0';
            setTimeout(()=>{
                const key = el.getAttribute('data-key');
                const txt = translations[currentLang] &&
                            translations[currentLang][key];
                if (txt) el.innerText = txt;
                el.style.opacity='1';
            },180);
        });

        renderRecentEvents();
    }

    if (langBtn) langBtn.addEventListener('click',toggleLanguage);
    if (mobileLang) mobileLang.addEventListener('click', ()=>{
        if (hamburger) hamburger.click();
        toggleLanguage();
    });

    /* MOBILE MENU */
    if (hamburger && mobileMenu) {
        hamburger.addEventListener('click',()=>{
            const open = mobileMenu.style.display === 'block';
            mobileMenu.style.display = open ? 'none':'block';
            mobileMenu.setAttribute('aria-hidden', open ? 'true':'false');
        });
    }

    /* NAVBAR SCROLL */
    if (navbar) {
        window.addEventListener('scroll',()=>{
            if(window.scrollY > 50)
                navbar.classList.add('solid');
            else
                navbar.classList.remove('solid');
        });
    }
});
